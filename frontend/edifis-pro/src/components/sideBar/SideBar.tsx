import { useEffect, useState } from "react";
import { NavLink } from "react-router-dom";
import { useAuth } from "../../context/AuthContext";
import { House, Construction, Hammer, UserRound, LogOut } from "lucide-react";
import timesheetService from "../../../services/timesheetService";

const routes = [
  { to: "/", label: "Accueil", Icon: House },
  { to: "/missions", label: "Missions", Icon: Hammer },
  { to: "/construction", label: "Chantiers", Icon: Construction },
];

export default function SideBar() {
  const { logout, user } = useAuth();
  const [isClockedIn, setIsClockedIn] = useState(false);
  const [loading, setLoading] = useState(true);

  // Au montage, on vérifie si l'utilisateur a un timesheet actif
  useEffect(() => {
    if (!user) {
      setLoading(false);
      return;
    }
    timesheetService
      .getActiveTimesheet(user.user_id)
      .then(({ active }) => {
        setIsClockedIn(active);
      })
      .catch((err) => console.error("Erreur getActiveTimesheet:", err))
      .finally(() => setLoading(false));
  }, [user]);

  const handleBadge = async () => {
    if (!user) return;
    try {
      if (!isClockedIn) {
        await timesheetService.clockIn(user.user_id);
        setIsClockedIn(true);
      } else {
        await timesheetService.clockOut(user.user_id);
        setIsClockedIn(false);
      }
    } catch (error) {
      console.error("Erreur clockIn/clockOut:", error);
    }
  };

  return (
    <aside className="fixed top-0 left-0 flex flex-col justify-between h-dvh w-[250px] bg-white border-r border-slate-200 pt-16 md:transform md:translate-x-0 transform -translate-x-full">
      <ul className="flex flex-col space-y-1.5 p-4">
        {routes.map(({ to, label, Icon }, index) => (
          <NavLink
            to={to}
            key={index}
            className="rounded-md cursor-pointer bg-transparent transition-colors hover:bg-slate-200"
          >
            <li className="flex items-center space-x-2 h-8 px-2.5">
              <Icon size={18} />
              <span className="text-slate-950 text-sm">{label}</span>
            </li>
          </NavLink>
        ))}
        {user?.role === "Admin" && (
          <NavLink
            to="/worker"
            className="rounded-md cursor-pointer bg-transparent transition-colors hover:bg-slate-200"
          >
            <li className="flex items-center space-x-2 h-8 px-2.5">
              <UserRound size={18} />
              <span className="text-slate-950 text-sm">Employés</span>
            </li>
          </NavLink>
        )}
      </ul>

      <div className="flex flex-col items-center p-4 space-y-4">
        {/* Bouton SVG de badgage */}
        {!loading && user && (
          <button
            onClick={handleBadge}
            className="inline-flex items-center justify-center p-2 rounded-full transition-colors focus:outline-none w-full"
          >
            <svg
              width="242"
              height="228"
              viewBox="0 0 242 228"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect
                width="242"
                height="228"
                rx="24"
                fill="url(#paint0_linear)"
              />
              <path
                d="M157.075 45.0029C153.273 41.1699 148.187 39.0186 142.888 39.0021H100.208C97.5748 38.9632 94.9599 39.4669 92.515 40.4839C90.0701 41.5009 87.8436 43.0111 85.9644 44.9272C84.0852 46.8432 82.5904 49.1271 81.5667 51.6467C80.5429 54.1663 80.0104 56.8716 80 59.6063V93.6388C80.0104 96.3501 80.5371 99.0324 81.5498 101.531C82.5625 104.03 84.0412 106.297 85.9008 108.2C89.6814 112.071 94.7774 114.242 100.087 114.243H142.767C148.077 114.242 153.173 112.071 156.953 108.2C158.826 106.307 160.313 104.042 161.326 101.541C162.34 99.0397 162.86 96.3525 162.854 93.6388V59.6063C162.872 56.8958 162.37 54.2088 161.377 51.7017C160.385 49.1946 158.923 46.9175 157.075 45.0029ZM120.053 96.4084C119.249 96.4084 118.478 96.0769 117.91 95.4866C117.341 94.8964 117.022 94.0959 117.022 93.2612C117.02 91.9893 116.777 90.7302 116.305 89.5563C115.833 88.3824 115.143 87.3169 114.273 86.4211C112.458 84.6781 110.077 83.7099 107.605 83.7099C105.132 83.7099 102.751 84.6781 100.936 86.4211C100.063 87.3141 99.3698 88.3791 98.8979 89.5536C98.4259 90.7281 98.1844 91.9886 98.1875 93.2612C98.1875 94.0959 97.8681 94.8964 97.2997 95.4866C96.7312 96.0769 95.9602 96.4084 95.1562 96.4084C94.3523 96.4084 93.5813 96.0769 93.0128 95.4866C92.4444 94.8964 92.125 94.0959 92.125 93.2612C92.1218 91.1558 92.5202 89.0707 93.2971 87.1261C94.074 85.1814 95.2141 83.4158 96.6517 81.931C98.0359 80.4334 99.6818 79.2229 101.502 78.364C99.8656 77.3205 98.5156 75.8575 97.5813 74.1159C96.647 72.3742 96.1599 70.4123 96.1667 68.4186C96.1667 65.3024 97.359 62.3138 99.4812 60.1103C101.604 57.9067 104.482 56.6688 107.483 56.6688C110.485 56.6688 113.363 57.9067 115.485 60.1103C117.608 62.3138 118.8 65.3024 118.8 68.4186C118.824 70.3964 118.361 72.3479 117.456 74.0882C116.551 75.8285 115.233 77.3003 113.627 78.364C115.474 79.1614 117.163 80.3154 118.598 81.7631C121.472 84.7827 123.096 88.8483 123.125 93.0933C123.153 93.5256 123.094 93.9592 122.951 94.3663C122.809 94.7735 122.585 95.1451 122.296 95.4574C122.007 95.7696 121.658 96.0155 121.271 96.1793C120.885 96.3431 120.47 96.4212 120.053 96.4084ZM146.445 92.7156H131.935C131.131 92.7156 130.36 92.384 129.792 91.7938C129.224 91.2036 128.904 90.4031 128.904 89.5684C128.904 88.7336 129.224 87.9331 129.792 87.3429C130.36 86.7527 131.131 86.4211 131.935 86.4211H146.445C147.249 86.4211 148.02 86.7527 148.588 87.3429C149.157 87.9331 149.476 88.7336 149.476 89.5684C149.476 90.4031 149.157 91.2036 148.588 91.7938C148.02 92.384 147.249 92.7156 146.445 92.7156ZM128.904 76.6016C128.904 75.7669 129.224 74.9663 129.792 74.3761C130.36 73.7859 131.131 73.4543 131.935 73.4543H138.16C138.964 73.4543 139.735 73.7859 140.303 74.3761C140.871 74.9663 141.191 75.7669 141.191 76.6016C141.191 77.4363 140.871 78.2368 140.303 78.827C139.735 79.4173 138.964 79.7488 138.16 79.7488H131.935C131.536 79.7545 131.139 79.6769 130.769 79.5208C130.399 79.3646 130.062 79.133 129.78 78.8396C129.497 78.5462 129.274 78.197 129.124 77.8126C128.973 77.4282 128.899 77.0164 128.904 76.6016ZM146.445 66.824H131.935C131.131 66.824 130.36 66.4924 129.792 65.9022C129.224 65.312 128.904 64.5115 128.904 63.6768C128.904 62.842 129.224 62.0415 129.792 61.4513C130.36 60.8611 131.131 60.5295 131.935 60.5295H146.445C147.249 60.5295 148.02 60.8611 148.588 61.4513C149.157 62.0415 149.476 62.842 149.476 63.6768C149.476 64.5115 149.157 65.312 148.588 65.9022C148.02 66.4924 147.249 66.824 146.445 66.824Z"
                fill="currentColor"
              />
              <path
                d="M21.0341 179V144.091H35.0114C37.5795 144.091 39.7216 144.472 41.4375 145.233C43.1534 145.994 44.4432 147.051 45.3068 148.403C46.1705 149.744 46.6023 151.29 46.6023 153.04C46.6023 154.403 46.3295 155.602 45.7841 156.636C45.2386 157.659 44.4886 158.5 43.5341 159.159C42.5909 159.807 41.5114 160.267 40.2955 160.54V160.881C41.625 160.937 42.8693 161.312 44.0284 162.006C45.1989 162.699 46.1477 163.67 46.875 164.92C47.6023 166.159 47.9659 167.636 47.9659 169.352C47.9659 171.205 47.5057 172.858 46.5852 174.312C45.6761 175.756 44.3295 176.898 42.5455 177.739C40.7614 178.58 38.5625 179 35.9489 179H21.0341ZM28.4148 172.966H34.4318C36.4886 172.966 37.9886 172.574 38.9318 171.79C39.875 170.994 40.3466 169.937 40.3466 168.619C40.3466 167.653 40.1136 166.801 39.6477 166.062C39.1818 165.324 38.517 164.744 37.6534 164.324C36.8011 163.903 35.7841 163.693 34.6023 163.693H28.4148V172.966ZM28.4148 158.699H33.8864C34.8977 158.699 35.7955 158.523 36.5795 158.17C37.375 157.807 38 157.295 38.4545 156.636C38.9205 155.977 39.1534 155.188 39.1534 154.267C39.1534 153.006 38.7045 151.989 37.8068 151.216C36.9205 150.443 35.6591 150.057 34.0227 150.057H28.4148V158.699ZM58.7855 179H50.8764L62.9276 144.091H72.4389L84.473 179H76.5639L67.8196 152.068H67.5469L58.7855 179ZM58.2912 165.278H76.973V171.04H58.2912V165.278ZM101.05 179H88.6747V144.091H101.152C104.663 144.091 107.686 144.79 110.22 146.188C112.754 147.574 114.703 149.568 116.067 152.17C117.442 154.773 118.129 157.886 118.129 161.511C118.129 165.148 117.442 168.273 116.067 170.886C114.703 173.5 112.743 175.506 110.186 176.903C107.641 178.301 104.595 179 101.05 179ZM96.0554 172.676H100.743C102.925 172.676 104.76 172.29 106.249 171.517C107.749 170.733 108.874 169.523 109.624 167.886C110.385 166.239 110.766 164.114 110.766 161.511C110.766 158.932 110.385 156.824 109.624 155.188C108.874 153.551 107.754 152.347 106.266 151.574C104.777 150.801 102.942 150.415 100.76 150.415H96.0554V172.676ZM146.744 155.375C146.506 154.545 146.17 153.812 145.739 153.176C145.307 152.528 144.778 151.983 144.153 151.54C143.54 151.085 142.835 150.739 142.04 150.5C141.256 150.261 140.386 150.142 139.432 150.142C137.648 150.142 136.08 150.585 134.727 151.472C133.386 152.358 132.341 153.648 131.591 155.341C130.841 157.023 130.466 159.08 130.466 161.511C130.466 163.943 130.835 166.011 131.574 167.716C132.313 169.42 133.358 170.722 134.71 171.619C136.062 172.506 137.659 172.949 139.5 172.949C141.17 172.949 142.597 172.653 143.778 172.062C144.972 171.46 145.881 170.614 146.506 169.523C147.142 168.432 147.46 167.142 147.46 165.653L148.96 165.875H139.96V160.318H154.568V164.716C154.568 167.784 153.92 170.42 152.625 172.625C151.33 174.818 149.545 176.511 147.273 177.705C145 178.886 142.398 179.477 139.466 179.477C136.193 179.477 133.318 178.756 130.841 177.312C128.364 175.858 126.432 173.795 125.045 171.125C123.67 168.443 122.983 165.261 122.983 161.58C122.983 158.75 123.392 156.227 124.21 154.011C125.04 151.784 126.199 149.898 127.688 148.352C129.176 146.807 130.909 145.631 132.886 144.824C134.864 144.017 137.006 143.614 139.312 143.614C141.29 143.614 143.131 143.903 144.835 144.483C146.54 145.051 148.051 145.858 149.369 146.903C150.699 147.949 151.784 149.193 152.625 150.636C153.466 152.068 154.006 153.648 154.244 155.375H146.744ZM160.112 179V144.091H183.635V150.176H167.493V158.494H182.425V164.58H167.493V172.915H183.703V179H160.112ZM189.503 179V144.091H203.276C205.912 144.091 208.162 144.562 210.026 145.506C211.901 146.437 213.327 147.761 214.304 149.477C215.293 151.182 215.787 153.187 215.787 155.494C215.787 157.812 215.287 159.807 214.287 161.477C213.287 163.136 211.838 164.409 209.94 165.295C208.054 166.182 205.77 166.625 203.088 166.625H193.866V160.693H201.895C203.304 160.693 204.474 160.5 205.406 160.114C206.338 159.727 207.031 159.148 207.486 158.375C207.952 157.602 208.185 156.642 208.185 155.494C208.185 154.335 207.952 153.358 207.486 152.562C207.031 151.767 206.332 151.165 205.389 150.756C204.457 150.335 203.281 150.125 201.861 150.125H196.884V179H189.503ZM208.355 163.114L217.031 179H208.884L200.395 163.114H208.355Z"
                fill="currentColor"
              />
              <defs>
                <linearGradient
                  id="paint0_linear"
                  x1="0"
                  y1="0"
                  x2="227.596"
                  y2="241.571"
                  gradientUnits="userSpaceOnUse"
                >
                  <stop stopColor={isClockedIn ? "#22C55E" : "#372AAC"} />
                  <stop
                    offset="1"
                    stopColor={isClockedIn ? "#22C55E" : "#4318FF"}
                  />
                </linearGradient>
              </defs>
            </svg>
          </button>
        )}

        {/* Bouton de déconnexion */}
        <button
          onClick={logout}
          className="inline-flex items-center justify-between whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-1 outline-offset-4 disabled:pointer-events-none disabled:opacity-50 bg-transparent text-slate-950 hover:bg-slate-200 h-9 w-full px-4 py-2 cursor-pointer"
        >
          Se déconnecter
          <LogOut size={18} className="ml-2" />
        </button>
      </div>
    </aside>
  );
}
